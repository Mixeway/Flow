<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="title-section">
            <h1 class="dashboard-title">Security Dashboard</h1>
            <p class="dashboard-subtitle">Overview of security findings across your repositories</p>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label class="filter-label" for="teamSelect">Scope</label>
                <select id="teamSelect" class="filter-select"
                        [(ngModel)]="selectedTeamValue"
                        (ngModelChange)="onTeamChange($event)">
                    <option value="">All Teams</option>
                    <option *ngFor="let team of availableTeams" [value]="team.teamId">{{ team.teamName }}</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Time Range</label>
                <div class="btn-group-toggle">
                    <button class="toggle-btn" [class.active]="timeRange === 7" (click)="onTimeRangeChange(7)">7d</button>
                    <button class="toggle-btn" [class.active]="timeRange === 30" (click)="onTimeRangeChange(30)">30d</button>
                    <button class="toggle-btn" [class.active]="timeRange === 90" (click)="onTimeRangeChange(90)">90d</button>
                </div>
            </div>

            <button class="refresh-btn" (click)="refreshData()" title="Refresh data">
                <svg cIcon name="cil-sync"></svg>
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-state">
        <c-spinner color="primary"></c-spinner>
        <p>Loading dashboard data...</p>
    </div>

    <div *ngIf="!isLoading" class="dashboard-content">
        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card kpi-blue">
                <div class="kpi-icon">
                    <svg cIcon name="cil-list" size="xl"></svg>
                </div>
                <div class="kpi-body">
                    <span class="kpi-label">Total Open Findings</span>
                    <span class="kpi-value">{{ formatNumber(summaryData.openTotal || 0) }}</span>
                    <span class="kpi-trend" [ngClass]="getTrendClass(getSeverityTrend('critical'))">
                        <svg cIcon [name]="getTrendIcon(getSeverityTrend('critical'))" size="sm"></svg>
                        {{ getSeverityTrend('critical') === 'up' ? 'Increasing' : getSeverityTrend('critical') === 'down' ? 'Decreasing' : 'Stable' }}
                    </span>
                </div>
            </div>

            <div class="kpi-card kpi-red">
                <div class="kpi-icon">
                    <svg cIcon name="cil-warning" size="xl"></svg>
                </div>
                <div class="kpi-body">
                    <span class="kpi-label">Critical</span>
                    <span class="kpi-value">{{ formatNumber(summaryData.criticalTotal || 0) }}</span>
                    <span class="kpi-trend" [ngClass]="getTrendClass(getSeverityTrend('critical'))">
                        <svg cIcon [name]="getTrendIcon(getSeverityTrend('critical'))" size="sm"></svg>
                        {{ getSeverityTrend('critical') === 'up' ? 'Increasing' : getSeverityTrend('critical') === 'down' ? 'Decreasing' : 'Stable' }}
                    </span>
                </div>
            </div>

            <div class="kpi-card kpi-purple">
                <div class="kpi-icon">
                    <svg cIcon name="cil-clock" size="xl"></svg>
                </div>
                <div class="kpi-body">
                    <span class="kpi-label">Avg. Fix Time</span>
                    <span class="kpi-value">{{ summaryData.averageFixTime || 0 }}<small>d</small></span>
                    <span class="kpi-trend text-muted">Based on resolved findings</span>
                </div>
            </div>

            <div class="kpi-card kpi-teal">
                <div class="kpi-icon">
                    <svg cIcon name="cil-storage" size="xl"></svg>
                </div>
                <div class="kpi-body">
                    <span class="kpi-label">Repositories</span>
                    <span class="kpi-value">{{ formatNumber(summaryData.totalRepos || 0) }}</span>
                    <span class="kpi-trend text-muted">Monitored for issues</span>
                </div>
            </div>
        </div>

        <!-- Vulnerability Trend -->
        <div class="chart-section">
            <div class="section-card full-width">
                <div class="section-header">
                    <h3>Vulnerability Trend</h3>
                    <span class="section-badge">Last {{ timeRange }} days</span>
                </div>
                <div class="chart-wrapper" style="height: 300px;">
                    <c-chart *ngIf="vulnerabilityTrendChartData" type="line"
                             [data]="vulnerabilityTrendChartData"
                             [options]="lineChartOptions"
                             style="max-height: 100%; width: 100%;"></c-chart>
                </div>
            </div>
        </div>

        <!-- Distribution Charts -->
        <div class="distribution-grid">
            <div class="section-card">
                <div class="section-header">
                    <h3>By Severity</h3>
                </div>
                <div class="chart-wrapper" style="height: 240px;">
                    <c-chart *ngIf="severityDistributionChartData" type="doughnut"
                             [data]="severityDistributionChartData"
                             [options]="doughnutChartOptions"></c-chart>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>By Source</h3>
                </div>
                <div class="chart-wrapper" style="height: 240px;">
                    <c-chart *ngIf="sourceDistributionChartData" type="doughnut"
                             [data]="sourceDistributionChartData"
                             [options]="doughnutChartOptions"></c-chart>
                </div>
            </div>

            <div class="section-card">
                <div class="section-header">
                    <h3>By Status</h3>
                </div>
                <div class="chart-wrapper" style="height: 240px;">
                    <c-chart *ngIf="statusDistributionChartData" type="doughnut"
                             [data]="statusDistributionChartData"
                             [options]="doughnutChartOptions"></c-chart>
                </div>
            </div>
        </div>

        <!-- Fix Progress -->
        <div class="chart-section">
            <div class="section-card full-width">
                <div class="section-header">
                    <h3>Fix Progress</h3>
                </div>
                <div class="chart-wrapper" style="height: 260px;">
                    <c-chart *ngIf="fixProgressChartData" type="line"
                             [data]="fixProgressChartData"
                             [options]="lineChartOptions"
                             style="max-height: 100%; width: 100%;"></c-chart>
                </div>
            </div>
        </div>

        <!-- Top Vulnerable Repos -->
        <div class="table-section">
            <div class="section-card full-width">
                <div class="section-header">
                    <h3>Top Vulnerable Repositories</h3>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Repository</th>
                            <th>Team</th>
                            <th class="text-center">Critical</th>
                            <th class="text-center">High</th>
                            <th class="text-center">Total</th>
                            <th class="text-end">Fix Time</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let repo of topRepos">
                            <td class="repo-name">{{ repo.repoName }}</td>
                            <td class="team-name">{{ repo.teamName }}</td>
                            <td class="text-center">
                                <span class="pill pill-critical">{{ repo.criticalCount }}</span>
                            </td>
                            <td class="text-center">
                                <span class="pill pill-high">{{ repo.highCount }}</span>
                            </td>
                            <td class="text-center fw-bold">{{ repo.totalVulnerabilities }}</td>
                            <td class="text-end text-muted">{{ repo.averageFixTime }}d</td>
                        </tr>
                        <tr *ngIf="topRepos.length === 0">
                            <td colspan="6" class="empty-state">
                                <svg cIcon name="cil-check-circle" size="lg"></svg>
                                <span>No vulnerability data available</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Teams Overview -->
        <div class="table-section">
            <div class="section-card full-width">
                <div class="section-header">
                    <h3>Teams Overview</h3>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Team</th>
                            <th class="text-center">Repos</th>
                            <th class="text-center">Critical</th>
                            <th class="text-center">High</th>
                            <th class="text-center">Total</th>
                            <th class="text-center">Fixed</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let team of teamsSummary">
                            <td class="team-name-primary">{{ team.teamName }}</td>
                            <td class="text-center">{{ team.repoCount }}</td>
                            <td class="text-center">
                                <span class="pill pill-critical">{{ team.criticalCount }}</span>
                            </td>
                            <td class="text-center">
                                <span class="pill pill-high">{{ team.highCount }}</span>
                            </td>
                            <td class="text-center fw-bold">{{ team.totalVulnerabilities }}</td>
                            <td class="text-center">
                                <span class="pill pill-success">{{ team.fixedVulnerabilities }}</span>
                            </td>
                        </tr>
                        <tr *ngIf="teamsSummary.length === 0">
                            <td colspan="6" class="empty-state">
                                <svg cIcon name="cil-check-circle" size="lg"></svg>
                                <span>No teams with vulnerability data</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
