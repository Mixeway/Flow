<c-modal size="lg" id="detailsModal" alignment="center" [visible]="detailsModal" (visibleChange)="handleDetailsModal($event)">
    <c-modal-header>
        <h5 cModalTitle>Vulnerability Details</h5>
    </c-modal-header>
    <c-modal-body>
        <div *ngIf="selectedRowId !== null">
            <!-- Basic Info Section -->
            <c-row>
                <c-col [xs]="8">
                    <c-card class="mb-4">
                        <c-card-header>
                            <h6 class="mb-0">{{ singleVuln?.vulnsResponseDto?.name }}</h6>
                        </c-card-header>
                        <c-card-body>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2">Location:</span>
                                <a [href]="getRepositoryLink()" target="_blank" class="text-primary d-flex align-items-center">
                                    <svg cIcon name="cib-git" class="me-2"></svg>
                                    <span>{{ getFormattedLocation() }}</span>
                                    <svg cIcon name="cil-external-link" class="ms-1" size="sm"></svg>
                                </a>
                            </div>
                        </c-card-body>
                        <c-card-footer>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-2">Status:</span>
                                <div class="d-flex align-items-center">
                                    <svg
                                            cIcon
                                            [name]="
                                            singleVuln?.vulnsResponseDto?.status === 'NEW' ? 'cil-burn' :
                                            singleVuln?.vulnsResponseDto?.status === 'EXISTING' ? 'cil-graph' :
                                            singleVuln?.vulnsResponseDto?.status === 'REMOVED' ? 'cil-trash' : 'cil-volume-off'
                                        "
                                            class="me-2"
                                    ></svg>
                                    <span>{{ singleVuln?.vulnsResponseDto?.status }}</span>
                                </div>
                            </div>
                        </c-card-footer>
                    </c-card>
                </c-col>
                <c-col [xs]="4">
                    <c-card class="mb-4">
                        <c-card-header>
                            <div class="d-flex align-items-center justify-content-center">
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'HIGH'" class="dot high"></span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'MEDIUM'" class="dot medium"></span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'LOW'" class="dot low"></span>
                                <span *ngIf="singleVuln?.vulnsResponseDto?.severity === 'INFO'" class="dot low"></span>
                                <c-spinner
                                        *ngIf="singleVuln?.vulnsResponseDto?.severity === 'CRITICAL'"
                                        color="danger"
                                        variant="grow"
                                        size="sm"
                                ></c-spinner>
                                <span
                                        *ngIf="singleVuln?.vulnsResponseDto?.severity === 'HIGH'"
                                        class="high-t ms-2"
                                >{{ singleVuln?.vulnsResponseDto?.severity }}</span>
                                <span
                                        *ngIf="singleVuln?.vulnsResponseDto?.severity === 'CRITICAL'"
                                        class="high-t ms-2"
                                >{{ singleVuln?.vulnsResponseDto?.severity }}</span>
                                <span
                                        *ngIf="singleVuln?.vulnsResponseDto?.severity === 'MEDIUM'"
                                        class="medium-t ms-2"
                                >{{ singleVuln?.vulnsResponseDto?.severity }}</span>
                                <span
                                        *ngIf="singleVuln?.vulnsResponseDto?.severity === 'LOW'"
                                        class="low-t ms-2"
                                >{{ singleVuln?.vulnsResponseDto?.severity }}</span>
                                <span
                                        *ngIf="singleVuln?.vulnsResponseDto?.severity === 'INFO'"
                                        class="low-t ms-2"
                                >{{ singleVuln?.vulnsResponseDto?.severity }}</span>
                            </div>
                        </c-card-header>
                        <c-card-body>
                            <div class="mb-2">
                                <span class="fw-bold me-2">Detected:</span>
                                <span>{{ singleVuln?.vulnsResponseDto?.inserted | date }}</span>
                            </div>
                            <div>
                                <span class="fw-bold me-2">Last Seen:</span>
                                <span>{{ singleVuln?.vulnsResponseDto?.last_seen | date }}</span>
                            </div>
                        </c-card-body>
                    </c-card>
                </c-col>
            </c-row>

            <!-- Tabs Section -->
            <c-row>
                <c-col xs="12">
                    <c-tabs [activeItemKey]="0" *ngIf="singleVuln">
                        <c-tabs-list variant="underline-border">
                            <button cTab [itemKey]="0">
                                <svg cIcon name="cil-notes" class="me-2"></svg>
                                Description
                            </button>
                            <button cTab [itemKey]="1">
                                <svg cIcon name="cil-lightbulb" class="me-2"></svg>
                                Recommendation
                            </button>
                            <button cTab [itemKey]="2">
                                <svg cIcon name="cil-description" class="me-2"></svg>
                                Explanation
                            </button>
                            <button cTab [itemKey]="3">
                                <svg cIcon name="cil-link" class="me-2"></svg>
                                References
                            </button>
                            <button cTab [itemKey]="4">
                                <svg cIcon name="cil-comment-square" class="me-2"></svg>
                                Comments
                                <c-badge *ngIf="singleVuln?.comments?.length" color="info" class="ms-1">
                                    {{ singleVuln.comments.length }}
                                </c-badge>
                            </button>
                        </c-tabs-list>
                        <c-tabs-content>
                            <c-tab-panel class="p-3" [itemKey]="0" *ngIf="singleVuln">
                                <markdown [data]="singleVuln.description || 'No description available at this moment'"></markdown>
                            </c-tab-panel>
                            <c-tab-panel class="p-3" [itemKey]="1" *ngIf="singleVuln">
                                <markdown [data]="singleVuln.recommendation || 'No recommendation available at this moment'"></markdown>
                            </c-tab-panel>
                            <c-tab-panel class="p-3" [itemKey]="2" *ngIf="singleVuln">
                                <markdown [data]="singleVuln.explanation || 'No explanation available at this moment'"></markdown>
                            </c-tab-panel>
                            <c-tab-panel class="p-3" [itemKey]="3" *ngIf="singleVuln">
                                <markdown [data]="singleVuln.refs || 'No references available at this moment'"></markdown>
                            </c-tab-panel>

                            <!-- Comments Tab -->
                            <c-tab-panel class="p-3" [itemKey]="4" *ngIf="singleVuln">
                                <!-- No comments message -->
                                <div *ngIf="!singleVuln?.comments?.length" class="text-center text-muted my-4">
                                    <svg cIcon name="cil-comment-square" width="32" height="32" class="mb-2 text-muted"></svg>
                                    <p>No comments yet. Be the first to comment!</p>
                                </div>

                                <!-- Comments list -->
                                <div class="comments-container">
                                    <div *ngFor="let comment of singleVuln?.comments" class="comment-item mb-3 pb-3 border-bottom">
                                        <div class="d-flex">
                                            <div class="comment-avatar">
                                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                    {{ comment.author.charAt(0).toUpperCase() }}
                                                </div>
                                            </div>
                                            <div class="ms-3 flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <strong>{{ comment.author }}</strong>
                                                    <small class="text-muted">{{ comment.inserted | date:'medium' }}</small>
                                                </div>
                                                <div class="comment-content mt-1 p-2 bg-light rounded">
                                                    {{ comment.message }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comment input -->
                                <div class="mt-3">
                                    <form (ngSubmit)="addComment()" class="d-flex">
                                        <input
                                                type="text"
                                                class="form-control me-2"
                                                [(ngModel)]="newComment"
                                                name="newComment"
                                                placeholder="Type your comment..."
                                                [disabled]="isAddingComment"
                                                (ngModelChange)="onNewCommentChange($event)"
                                                required
                                        >
                                        <button
                                                cButton
                                                color="primary"
                                                type="submit"
                                                [disabled]="!newComment.trim() || isAddingComment"
                                        >
                                            <c-spinner *ngIf="isAddingComment" size="sm" class="me-1"></c-spinner>
                                            Send
                                        </button>
                                    </form>
                                </div>
                            </c-tab-panel>
                        </c-tabs-content>
                    </c-tabs>
                </c-col>
            </c-row>
        </div>
    </c-modal-body>

    <!-- Action Buttons Section -->
    <c-modal-footer>
        <div class="w-100 d-flex justify-content-between align-items-center">
            <div>
                <form *ngIf="singleVuln?.vulnsResponseDto?.status != 'SUPRESSED'" class="d-flex align-items-center" (ngSubmit)="suppressFinding()">
                    <label for="suppressReason" class="me-2">Suppress finding: </label>
                    <select id="suppressReason" class="form-select me-2" [(ngModel)]="suppressReason" name="suppressReason" required>
                        <option value="" disabled selected>Select a reason</option>
                        <option *ngFor="let reason of suppressReasons" [value]="reason">{{ reason }}</option>
                    </select>
                    <button type="submit" cButton color="warning" [disabled]="!suppressReason">
                        <svg cIcon name="cil-volume-off" class="me-1"></svg>
                        Suppress
                    </button>
                </form>
                <button
                        (click)="reactivateFinding()"
                        *ngIf="singleVuln?.vulnsResponseDto?.status == 'SUPRESSED'"
                        cButton
                        color="success"
                >
                    <svg cIcon name="cil-volume-high" class="me-1"></svg>
                    Re-Activate Finding
                </button>
            </div>
            <button (click)="closeModal()" cButton color="secondary">Close</button>
        </div>
    </c-modal-footer>
</c-modal>