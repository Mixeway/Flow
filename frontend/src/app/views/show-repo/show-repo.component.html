<!-- Repository Info Component -->
<app-repository-info
        [repoData]="repoData"
        [scanRunning]="scanRunning"
        [userRole]="userRole"
        [topLanguages]="topLanguages"
        [chartPieData]="chartPieData"
        [options]="options"
        (runScanEvent)="runScan()"
        (openChangeTeamModalEvent)="openChangeTeamModal()"
></app-repository-info>

<!-- Vulnerability Summary Component -->
<div class="mt-4">
    <app-vulnerability-summary
            [counts]="counts"
            [icons]="icons"
    ></app-vulnerability-summary>
</div>

<!-- Main Content with Tabs -->
<div class="repo-tabs-container mt-4">
    <c-card>
        <c-tabs>
            <c-tabs-list variant="underline-border">
                <button cTab [itemKey]="0">
                    <svg cIcon name="cil-bug" class="me-2"></svg>
                    Vulnerabilities
                </button>
                <button cTab [itemKey]="1">
                    <svg cIcon name="cil-chart-line" class="me-2"></svg>
                    Statistics & Trends
                </button>
                <button cTab [itemKey]="2">
                    <svg cIcon name="cil-magnifying-glass" class="me-2"></svg>
                    Scan Info
                </button>
                <button cTab [itemKey]="3">
                    <svg cIcon name="cil-share-alt" class="me-2"></svg>
                    Data Privacy
                </button>
                <button cTab [itemKey]="4">
                    <svg cIcon name="cil-puzzle" class="me-2"></svg>
                    Components
                </button>
                <button cTab [itemKey]="5">
                    <svg cIcon name="cil-burn" class="me-2"></svg>
                    Notifications
                </button>
                <button cTab [itemKey]="6">
                    <svg cIcon name="cil-info" class="me-2"></svg>
                    Additional Info
                </button>
            </c-tabs-list>

            <c-tabs-content>
                <!-- Vulnerabilities Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="0">
                    <app-vulnerabilities-table
                            [repoData]="repoData"
                            [vulns]="vulns"
                            [filteredVulns]="filteredVulns"
                            [selectedBranch]="selectedBranch"
                            [showRemoved]="showRemoved"
                            [showSuppressed]="showSuppressed"
                            [bulkActionMode]="bulkActionMode"
                            [selectedFindings]="selectedFindings"
                            [vulnerabilitiesLoading]="vulnerabilitiesLoading"
                            [vulnerabilitiesLimit]="vulnerabilitiesLimit"
                            (updateFilterNameEvent)="updateFilterName($event)"
                            (updateFilterLocationEvent)="updateFilterLocation($event)"
                            (updateFilterSourceEvent)="updateFilterSource($event)"
                            (updateFilterStatusEvent)="updateFilterStatus($event)"
                            (updateFilterSeverityEvent)="updateFilterSeverity($event)"
                            (toggleShowRemovedEvent)="toggleShowRemoved($event)"
                            (toggleShowSuppressedEvent)="toggleShowSuppressed($event)"
                            (toggleBulkActionEvent)="toggleBulkAction()"
                            (selectAllFindingsEvent)="selectAllFindings($event)"
                            (onSelectFindingEvent)="onSelectFinding($event.id, $event.event)"
                            (suppressSelectedFindingsEvent)="suppressSelectedFindings()"
                            (onBranchSelectEvent)="onBranchSelect($event)"
                            (viewVulnerabilityDetailsEvent)="viewVulnerabilityDetails($event)"
                            (clearFiltersEvent)="clearVulnerabilityFilters()"
                    ></app-vulnerabilities-table>
                </c-tab-panel>

                <!-- Statistics and Trends Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="1">
                    <div class="statistics-container">
                        <!-- Trend Chart -->
                        <c-card class="trend-chart-card mb-4">
                            <c-card-header class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Vulnerability Trend - Default Branch</h5>
                                <button cButton color="light" variant="ghost" class="refresh-btn" (click)="refreshData()" [cTooltip]="'Refresh data'">
                                    <svg cIcon name="cil-sync"></svg>
                                </button>
                            </c-card-header>
                            <c-card-body>
                                <c-chart type="line" [data]="chartLineData" [options]="options2"></c-chart>
                            </c-card-body>
                        </c-card>

                        <!-- Stats Metrics -->
                        <div class="stats-metrics-container">
                            <c-row>
                                <c-col [md]="6" [sm]="12" class="mb-4">
                                    <div class="metric-card opened-findings">
                                        <div class="metric-icon">
                                            <svg cIcon name="cilChartLine" height="36"></svg>
                                        </div>
                                        <div class="metric-content">
                                            <h6 class="metric-title">Opened Findings</h6>
                                            <div class="metric-value">{{ getLastOpenedFindings() === 0 ? 'None' : getLastOpenedFindings() }}</div>
                                            <c-progress class="metric-progress" thin [value]="75" color="info"></c-progress>
                                        </div>
                                    </div>
                                </c-col>

                                <c-col [md]="6" [sm]="12" class="mb-4">
                                    <div class="metric-card closed-findings">
                                        <div class="metric-icon">
                                            <svg cIcon name="cilInput" height="36"></svg>
                                        </div>
                                        <div class="metric-content">
                                            <h6 class="metric-title">Closed Findings</h6>
                                            <div class="metric-value">{{ getLastRemovedFinding() === 0 ? 'None' : getLastRemovedFinding() }}</div>
                                            <c-progress class="metric-progress" thin [value]="75" color="success"></c-progress>
                                        </div>
                                    </div>
                                </c-col>

                                <c-col [md]="6" [sm]="12" class="mb-4">
                                    <div class="metric-card reviewed-findings">
                                        <div class="metric-icon">
                                            <svg cIcon name="cilBrush" height="36"></svg>
                                        </div>
                                        <div class="metric-content">
                                            <h6 class="metric-title">Reviewed Findings</h6>
                                            <div class="metric-value">{{ getLastRevievedFinding() === 0 ? 'None' : getLastRevievedFinding() }}</div>
                                            <c-progress class="metric-progress" thin [value]="80" color="warning"></c-progress>
                                        </div>
                                    </div>
                                </c-col>

                                <c-col [md]="6" [sm]="12" class="mb-4">
                                    <div class="metric-card fix-time">
                                        <div class="metric-icon">
                                            <svg cIcon name="cilClock" height="36"></svg>
                                        </div>
                                        <div class="metric-content">
                                            <h6 class="metric-title">Time to Fix</h6>
                                            <div class="metric-value">{{ getLastFixTime() === 0 ? 'Unknown' : getLastFixTime() }} <span class="metric-unit">days</span></div>
                                            <c-progress class="metric-progress" thin [value]="65" color="danger"></c-progress>
                                        </div>
                                    </div>
                                </c-col>
                            </c-row>
                        </div>
                    </div>
                </c-tab-panel>

                <!-- Scan Info Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="2">
                    <c-card class="scan-info-card">
                        <c-card-header>
                            <h5 class="mb-0">Scan History</h5>
                        </c-card-header>
                        <c-card-body>
                            <!-- Loading State -->
                            <div *ngIf="scanInfoLoading" class="loading-container">
                                <c-spinner color="primary"></c-spinner>
                                <span class="loading-text">Loading scan history...</span>
                            </div>

                            <!-- Content when data is loaded -->
                            <div *ngIf="!scanInfoLoading" class="scan-content">
                                <!-- Search and Filter Controls -->
                                <div class="scan-controls">
                                    <div class="scan-search">
                                        <div class="input-group">
                      <span class="input-group-text">
                        <svg cIcon name="cil-magnifying-glass"></svg>
                      </span>
                                            <input
                                                    type="text"
                                                    class="form-control"
                                                    placeholder="Search by commit ID or branch..."
                                                    (input)="updateScanInfoFilter($event)"
                                            />
                                        </div>
                                    </div>

                                    <div class="scan-page-size">
                                        <label class="page-size-label">Show</label>
                                        <select class="form-select page-size-select" [(ngModel)]="scanInfoLimit">
                                            <option [value]="10">10</option>
                                            <option [value]="20">20</option>
                                            <option [value]="50">50</option>
                                            <option [value]="100">100</option>
                                            <option [value]="200">200</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Scan History Table -->
                                <div class="scan-table">
                                    <ngx-datatable
                                            class="bootstrap scan-datatable"
                                            [rows]="scanInfosFiltered"
                                            [columnMode]="'force'"
                                            [footerHeight]="50"
                                            [headerHeight]="50"
                                            [rowHeight]="'auto'"
                                            [limit]="scanInfoLimit"
                                            [sorts]="[{prop: 'insertedDate', dir: 'desc'}]"
                                    >
                                        <!-- Branch Column -->
                                        <ngx-datatable-column
                                                name="Branch"
                                                prop="codeRepoBranch.name"
                                                [width]="150"
                                        >
                                            <ng-template ngx-datatable-header-template>
                                                <span class="column-header">Branch</span>
                                            </ng-template>
                                            <ng-template
                                                    ngx-datatable-cell-template
                                                    let-row="row"
                                            >
                                                <div class="branch-cell">
                                                    <svg cIcon name="cil-share-alt" class="branch-icon"></svg>
                                                    <span class="branch-name">{{ row?.codeRepoBranch?.name }}</span>
                                                </div>
                                            </ng-template>
                                        </ngx-datatable-column>

                                        <!-- CommitId Column -->
                                        <ngx-datatable-column
                                                name="Commit ID"
                                                prop="commitId"
                                                [width]="220"
                                        >
                                            <ng-template ngx-datatable-header-template>
                                                <span class="column-header">Commit ID</span>
                                            </ng-template>
                                            <ng-template
                                                    ngx-datatable-cell-template
                                                    let-row="row"
                                            >
                                                <div class="commit-cell">
                                                    <code class="commit-id">{{ row.commitId }}</code>
                                                </div>
                                            </ng-template>
                                        </ngx-datatable-column>

                                        <!-- Scan Date Column -->
                                        <ngx-datatable-column
                                                name="Scan Date"
                                                prop="insertedDate"
                                                [width]="170"
                                        >
                                            <ng-template ngx-datatable-header-template>
                                                <span class="column-header">Scan Date</span>
                                            </ng-template>
                                            <ng-template
                                                    ngx-datatable-cell-template
                                                    let-row="row"
                                            >
                                                <div class="date-cell">
                                                    <svg cIcon name="cil-calendar" class="date-icon"></svg>
                                                    <span class="scan-date">{{ row.insertedDate | date:'medium' }}</span>
                                                </div>
                                            </ng-template>
                                        </ngx-datatable-column>

                                        <!-- Results Column -->
                                        <ngx-datatable-column
                                                name="Results"
                                                [width]="220"
                                        >
                                            <ng-template ngx-datatable-header-template>
                                                <span class="column-header">Results</span>
                                            </ng-template>
                                            <ng-template
                                                    ngx-datatable-cell-template
                                                    let-row="row"
                                            >
                                                <div class="results-cell">
                                                    <div class="result-category">
                                                        <span class="category-label">SAST</span>
                                                        <div class="category-badges">
                                                            <c-badge color="danger" class="result-badge" *ngIf="row.sastCritical > 0">{{ row.sastCritical }}</c-badge>
                                                            <c-badge color="warning" class="result-badge" *ngIf="row.sastHigh > 0">{{ row.sastHigh }}</c-badge>
                                                            <c-badge color="info" class="result-badge" *ngIf="row.sastMedium > 0">{{ row.sastMedium }}</c-badge>
                                                        </div>
                                                    </div>

                                                    <div class="result-category">
                                                        <span class="category-label">SCA</span>
                                                        <div class="category-badges">
                                                            <c-badge color="danger" class="result-badge" *ngIf="row.scaCritical > 0">{{ row.scaCritical }}</c-badge>
                                                            <c-badge color="warning" class="result-badge" *ngIf="row.scaHigh > 0">{{ row.scaHigh }}</c-badge>
                                                            <c-badge color="info" class="result-badge" *ngIf="row.scaMedium > 0">{{ row.scaMedium }}</c-badge>
                                                        </div>
                                                    </div>

                                                    <div class="result-category">
                                                        <span class="category-label">IaC</span>
                                                        <div class="category-badges">
                                                            <c-badge color="danger" class="result-badge" *ngIf="row.iacCritical > 0">{{ row.iacCritical }}</c-badge>
                                                            <c-badge color="warning" class="result-badge" *ngIf="row.iacHigh > 0">{{ row.iacHigh }}</c-badge>
                                                            <c-badge color="info" class="result-badge" *ngIf="row.iacMedium > 0">{{ row.iacMedium }}</c-badge>
                                                        </div>
                                                    </div>

                                                    <div class="result-category">
                                                        <span class="category-label">Secrets</span>
                                                        <div class="category-badges">
                                                            <c-badge color="danger" class="result-badge" *ngIf="row.secretsCritical > 0">{{ row.secretsCritical }}</c-badge>
                                                            <c-badge color="warning" class="result-badge" *ngIf="row.secretsHigh > 0">{{ row.secretsHigh }}</c-badge>
                                                            <c-badge color="info" class="result-badge" *ngIf="row.secretsMedium > 0">{{ row.secretsMedium }}</c-badge>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-template>
                                        </ngx-datatable-column>
                                    </ngx-datatable>

                                    <!-- Empty state for no results -->
                                    <div *ngIf="scanInfosFiltered.length === 0" class="empty-state">
                                        <svg cIcon name="cil-magnifying-glass" width="48" height="48"></svg>
                                        <h5>No scan history found</h5>
                                        <p>No scans match your search criteria or no scans have been performed yet.</p>
                                        <button cButton color="primary" (click)="updateScanInfoFilter({target: {value: ''}})">Clear search</button>
                                    </div>
                                </div>
                            </div>
                        </c-card-body>
                    </c-card>
                </c-tab-panel>

                <!-- Data Privacy Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="3">
                    <c-accordion>
                        <ng-container *ngFor="let group of grouppedDataTypes; let i = index">
                            <c-accordion-item [visible]="isAccordionVisible[i]">
                                <ng-template cTemplateId="accordionHeaderTemplate">
                                    <button (click)="toggleAccordion(i)" [collapsed]="!isAccordionVisible[i]" cAccordionButton>
                                        {{ group.categoryGroup }}
                                    </button>
                                </ng-template>
                                <ng-template cTemplateId="accordionBodyTemplate">
                                    <div class="accordion-body">
                                        <c-card *ngFor="let appDataType of group.appDataTypes" class="mb-3">
                                            <c-card-header>
                                                <c-badge color="primary">{{ appDataType.categoryName }} - {{ appDataType.name }}</c-badge>
                                            </c-card-header>
                                            <c-card-body>
                                                <ul cListGroup>
                                                    <li *ngFor="let locationKey of getKeys(appDataType.location)" cListGroupItem>
                                                        <c-badge color="secondary">{{ locationKey }}</c-badge> :
                                                        <c-badge color="secondary">{{ appDataType?.location?.[locationKey] }}</c-badge>
                                                    </li>
                                                </ul>
                                            </c-card-body>
                                        </c-card>
                                    </div>
                                </ng-template>
                            </c-accordion-item>
                        </ng-container>
                    </c-accordion>
                </c-tab-panel>

                <!-- OpenSource Components Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="4">
                    <c-card class="components-card">
                        <c-card-header>
                            <h5 class="mb-0">Detected Dependencies</h5>
                            <p class="text-muted mb-0">Open-source components identified in the codebase</p>
                        </c-card-header>
                        <c-card-body>
                            <!-- Components Controls -->
                            <div class="components-controls mb-4">
                                <div class="components-filter">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="filter-group">
                                                <label class="filter-label">Group</label>
                                                <div class="input-group">
                          <span class="input-group-text">
                            <svg cIcon name="cil-filter" class="filter-icon"></svg>
                          </span>
                                                    <input
                                                            type="text"
                                                            class="form-control"
                                                            placeholder="Filter by group"
                                                            (input)="updateFilterGroup($event)"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="filter-group">
                                                <label class="filter-label">Name</label>
                                                <div class="input-group">
                          <span class="input-group-text">
                            <svg cIcon name="cil-filter" class="filter-icon"></svg>
                          </span>
                                                    <input
                                                            type="text"
                                                            class="form-control"
                                                            placeholder="Filter by name"
                                                            (input)="updateFilterNameNew($event)"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="filter-group">
                                                <label class="filter-label">Version</label>
                                                <div class="input-group">
                          <span class="input-group-text">
                            <svg cIcon name="cil-filter" class="filter-icon"></svg>
                          </span>
                                                    <input
                                                            type="text"
                                                            class="form-control"
                                                            placeholder="Filter by version"
                                                            (input)="updateFilterVersion($event)"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="components-pagination mt-3 d-flex justify-content-between align-items-center">
                                    <div class="components-count" *ngIf="filteredComponents.length > 0">
                                        <span class="badge bg-info">{{ filteredComponents.length }} components</span>
                                    </div>

                                    <div class="components-page-size d-flex align-items-center">
                                        <label class="page-size-label me-2">Show</label>
                                        <select class="form-select page-size-select" [(ngModel)]="componentsLimit">
                                            <option [value]="10">10</option>
                                            <option [value]="20">20</option>
                                            <option [value]="50">50</option>
                                            <option [value]="100">100</option>
                                            <option [value]="200">200</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Components Table -->
                            <div class="components-table">
                                <ngx-datatable
                                        class="bootstrap components-datatable"
                                        [rows]="filteredComponents"
                                        [columnMode]="'force'"
                                        [footerHeight]="50"
                                        [headerHeight]="50"
                                        [rowHeight]="'auto'"
                                        [limit]="componentsLimit"
                                >
                                    <!-- Group Column -->
                                    <ngx-datatable-column name="Group" prop="groupid">
                                        <ng-template
                                                ngx-datatable-cell-template
                                                let-row="row"
                                        >
                                            <div class="group-cell" [cTooltip]="row?.groupid">
                                                {{ row?.groupid }}
                                            </div>
                                        </ng-template>
                                    </ngx-datatable-column>

                                    <!-- Name Column -->
                                    <ngx-datatable-column name="Name" prop="name">
                                        <ng-template
                                                ngx-datatable-cell-template
                                                let-row="row"
                                        >
                                            <div class="name-cell">
                                                <strong>{{ row?.name }}</strong>
                                            </div>
                                        </ng-template>
                                    </ngx-datatable-column>

                                    <!-- Version Column -->
                                    <ngx-datatable-column name="Version" prop="version" [width]="120">
                                        <ng-template
                                                ngx-datatable-cell-template
                                                let-row="row"
                                        >
                                            <div class="version-cell">
                                                <c-badge color="info">{{ row?.version }}</c-badge>
                                            </div>
                                        </ng-template>
                                    </ngx-datatable-column>
                                </ngx-datatable>

                                <!-- Empty state for no results -->
                                <div *ngIf="filteredComponents.length === 0" class="empty-state">
                                    <svg cIcon name="cil-puzzle" width="48" height="48"></svg>
                                    <h5>No components found</h5>
                                    <p>No components match your filter criteria.</p>
                                    <button cButton color="primary" (click)="clearComponentFilters()">Clear filters</button>
                                </div>
                            </div>
                        </c-card-body>
                    </c-card>
                </c-tab-panel>

                <!-- Notifications Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="5">
                    <c-alert color="primary" class="d-flex align-items-center">
                        <svg
                                class="bi flex-shrink-0 me-2"
                                width="24"
                                height="24"
                                role="img"
                                aria-label="Info:"
                        >
                            <use xlink:href="#info-fill" />
                        </svg>
                        <div>
                            This part will be developed in next releases. In this section You will discover
                            information about notification
                        </div>
                    </c-alert>
                </c-tab-panel>

                <!-- Additional Infos Tab -->
                <c-tab-panel class="tab-content-panel" [itemKey]="6">
                    <c-alert color="primary" class="d-flex align-items-center">
                        <svg
                                class="bi flex-shrink-0 me-2"
                                width="24"
                                height="24"
                                role="img"
                                aria-label="Info:"
                        >
                            <use xlink:href="#info-fill" />
                        </svg>
                        <div>
                            This part will be developed in next releases. In this section You will discover
                            information about how to integrate MixewayFlow for this repo into CICD smoothly
                        </div>
                    </c-alert>
                </c-tab-panel>
            </c-tabs-content>
        </c-tabs>
    </c-card>
</div>

<!-- Vulnerability Details Modal -->
<app-vulnerability-details
        [detailsModal]="detailsModal"
        [selectedRowId]="selectedRowId"
        [singleVuln]="singleVuln"
        [suppressReason]="suppressReason"
        [suppressReasons]="suppressReasons"
        [repoData]="repoData"
        [selectedBranch]="selectedBranch"
        [isAddingComment]="isAddingComment"
        [newComment]="newComment"
        (handleDetailsModalEvent)="handleDetailsModal($event)"
        (closeModalEvent)="closeModal()"
        (suppressFindingEvent)="suppressFinding()"
        (reactivateFindingEvent)="reactivateFinding()"
        (addCommentEvent)="addComment()"
        (newCommentChange)="newComment = $event"
></app-vulnerability-details>

<!-- Toast Notifications -->
<c-toaster [placement]="position" class="p-3" position="fixed">
    <c-toast
            [color]="toastStatus"
            (visibleChange)="onVisibleChange($event)"
            [visible]="visible">
        <c-toast-header>
            Finding management
        </c-toast-header>
        <c-toast-body>
            <p>{{toastMessage}}</p>
        </c-toast-body>
    </c-toast>
</c-toaster>

<!-- Add Change Team Modal -->
<c-modal size="lg"
         id="changeTeamModal"
         alignment="center"
         [visible]="changeTeamModalVisible"
         (visibleChange)="changeTeamModalVisible = $event">
    <c-modal-header>
        <h5 cModalTitle>Change Team</h5>
    </c-modal-header>
    <c-modal-body>
        <div class="mb-3">
            <label cLabel for="newTeamSelect">Select New Team</label>
            <select id="newTeamSelect"
                    class="form-select"
                    [(ngModel)]="selectedNewTeamId">
                <option [ngValue]="null">Choose a team...</option>
                <option *ngFor="let team of availableTeams"
                        [ngValue]="team.id">
                    {{ team.name }}
                </option>
            </select>
        </div>
    </c-modal-body>
    <c-modal-footer>
        <button (click)="closeChangeTeamModal()"
                cButton
                color="secondary">
            Close
        </button>
        <button (click)="confirmTeamChange()"
                cButton
                color="primary"
                [disabled]="!selectedNewTeamId">
            Change Team
        </button>
    </c-modal-footer>
</c-modal>

<!-- Add Confirmation Modal -->
<c-modal size="lg"
         id="confirmationModal"
         alignment="center"
         [visible]="confirmationModalVisible"
         (visibleChange)="confirmationModalVisible = $event">
    <c-modal-header>
        <h5 cModalTitle>Confirm Team Change</h5>
    </c-modal-header>
    <c-modal-body>
        <div class="alert alert-warning">
            <h4 class="alert-heading">Warning!</h4>
            <p>You are about to change the team for this repository. This action cannot be undone.</p>
            <p>Please type "accept" to confirm this change:</p>
        </div>
        <div class="mb-3">
            <input type="text"
                   class="form-control"
                   [(ngModel)]="confirmationText"
                   placeholder="Type 'accept' to confirm">
        </div>
    </c-modal-body>
    <c-modal-footer>
        <button (click)="closeConfirmationModal()"
                cButton
                color="secondary">
            Cancel
        </button>
        <button (click)="executeTeamChange()"
                cButton
                color="danger"
                [disabled]="confirmationText !== 'accept'">
            Change Team
        </button>
    </c-modal-footer>
</c-modal>